#!/bin/bash
# check variables, like all scripts herein do
WRS_SCRIPT_NAME=$(basename $0)
if [ -z "$WRS_BASE_DIR" ]; then
    echo "$0: Plesae set WRS_BASE_DIR" >& 2
    exit 1
fi
. ${WRS_BASE_DIR}/scripts/wrs_functions

# This step is controlled by Kconfig: skip it if not selected
if [ "x$CONFIG_PPSI" = "x" ]; then
    exit 0
fi

wrs_check_vars WRS_OUTPUT_DIR WRS_DOWNLOAD_DIR CROSS_COMPILE

wrs_echo "--- PTP daemon (PPSi repository as a submodule)"

# checkout, in case the user didn't do that
cd ${WRS_BASE_DIR}/..
git submodule init -q
git submodule update -q
cd userspace/ppsi
make clean

# we need LINUX and CROSS_COMPILE. The latter is there for sure
if [ "x$LINUX" == "x" ]; then
    export LINUX="$WRS_OUTPUT_DIR/build/linux-2.6.39"
fi

make ARCH=wrs PROTO_EXT=whiterabbit || wrs_die "cannot build PPSi"
install -d "$WRS_OUTPUT_DIR/images/wr/bin"
install ppsi "$WRS_OUTPUT_DIR/images/wr/bin"
